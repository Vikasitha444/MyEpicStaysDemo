<!-- templates/home.html -->
{% extends 'base.html' %}

{% block title %}QR Code Verification - Hotel Booking{% endblock %}

{% block content %}
<div class="qr-card">
    
    <div class="qr-code-container">
        <h5 style="color: #666; margin-bottom: 20px;">QR Code Scan කරන්න</h5>
        <img src="{{ qr_code }}" alt="QR Code" class="qr-code-img">
    </div>
    
    <div class="verification-section">
        <input 
            type="text" 
            id="tokenInput" 
            class="form-control token-input" 
            placeholder="6 digit code එක enter කරන්න"
            maxlength="6"
            autocomplete="off"
        >
        
        <button 
            type="button" 
            id="verifyBtn" 
            class="btn verify-btn"
            onclick="verifyToken()"
        >
            ✓ Verify Code
        </button>
    </div>
    
    <div id="alertContainer"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const sessionId = '{{ session_id }}';
    
    // Auto-submit when 6 digits entered
    document.getElementById('tokenInput').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, ''); // Only numbers
        e.target.value = value;
        
        if (value.length === 6) {
            verifyToken();
        }
    });
    
    // Enter key submit
    document.getElementById('tokenInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            verifyToken();
        }
    });
    
    function verifyToken() {
        const token = document.getElementById('tokenInput').value;
        const verifyBtn = document.getElementById('verifyBtn');
        const alertContainer = document.getElementById('alertContainer');
        
        if (!token || token.length !== 6) {
            showAlert('6 digit code එක enter කරන්න', 'danger');
            return;
        }
        
        // Disable button during verification
        verifyBtn.disabled = true;
        verifyBtn.innerHTML = '⏳ Verifying...';
        
        // Make AJAX request
        fetch('/verify-qr/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                session_id: sessionId,
                token: token
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(data.message, 'success');
                document.getElementById('tokenInput').value = '';
                
                // Add success animation
                document.querySelector('.qr-card').classList.add('success-animation');
                
                // Reset after animation
                setTimeout(() => {
                    document.querySelector('.qr-card').classList.remove('success-animation');
                }, 600);
                
            } else {
                showAlert(data.message, 'danger');
                document.getElementById('tokenInput').value = '';
                document.getElementById('tokenInput').focus();
            }
        })
        .catch(error => {
            showAlert('Something went wrong. Try again.', 'danger');
            console.error('Error:', error);
        })
        .finally(() => {
            // Re-enable button
            verifyBtn.disabled = false;
            verifyBtn.innerHTML = '✓ Verify Code';
        });
    }
    
    function showAlert(message, type) {
        const alertContainer = document.getElementById('alertContainer');
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const icon = type === 'success' ? '✅' : '❌';
        
        alertContainer.innerHTML = `
            <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                ${icon} ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
            const alert = alertContainer.querySelector('.alert');
            if (alert) {
                alert.classList.remove('show');
                setTimeout(() => {
                    alertContainer.innerHTML = '';
                }, 150);
            }
        }, 5000);
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Focus on input when page loads
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('tokenInput').focus();
    });
</script>
{% endblock %}